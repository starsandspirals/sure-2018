<?xml version="1.0" encoding="utf-8"?>
<gpu:xmodel xmlns:gpu="http://www.dcs.shef.ac.uk/~paul/XMMLGPU" 
  xmlns="http://www.dcs.shef.ac.uk/~paul/XMML">
  <name>Project</name>
  <gpu:environment>
    <!-- Variables that can be set in the input data -->
    <gpu:constants>
      <gpu:variable>
        <type>float</type>
        <name>TIME_STEP</name>
        <defaultValue>1.0</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>unsigned int</type>
        <name>MAX_AGE</name>
        <defaultValue>100</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>STARTING_POPULATION</name>
        <defaultValue>30000.0</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_BETA0</name>
        <defaultValue>2.19261</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_BETA1</name>
        <defaultValue>0.14679</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>unsigned int</type>
        <name>CHURCH_K1</name>
        <defaultValue>13</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>unsigned int</type>
        <name>CHURCH_K2</name>
        <defaultValue>35</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>unsigned int</type>
        <name>CHURCH_K3</name>
        <defaultValue>100</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_P1</name>
        <defaultValue>0.14</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_P2</name>
        <defaultValue>0.32</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_PROB0</name>
        <defaultValue>0.285569106</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_PROB1</name>
        <defaultValue>0.704268293</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_PROB2</name>
        <defaultValue>0.864329269</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_PROB3</name>
        <defaultValue>0.944613822</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_PROB4</name>
        <defaultValue>0.978658537</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_PROB5</name>
        <defaultValue>0.981707317</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_PROB6</name>
        <defaultValue>0.985772358</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>CHURCH_DURATION</name>
        <defaultValue>0.5</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>TRANSPORT_BETA0</name>
        <defaultValue>1.682127</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>TRANSPORT_BETA1</name>
        <defaultValue>-0.007739</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>TRANSPORT_FREQ0</name>
        <defaultValue>0.4337998</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>TRANSPORT_FREQ2</name>
        <defaultValue>0.8439182</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>TRANSPORT_DUR20</name>
        <defaultValue>0.5011086</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>TRANSPORT_DUR45</name>
        <defaultValue>0.8381374</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>unsigned int</type>
        <name>TRANSPORT_SIZE</name>
        <defaultValue>15</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>HIV_PREVALENCE</name>
        <defaultValue>0.14</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>ART_COVERAGE</name>
        <defaultValue>0.21</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>RR_HIV</name>
        <defaultValue>4.5</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>RR_ART</name>
        <defaultValue>0.4</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>TB_PREVALENCE</name>
        <defaultValue>0.005</defaultValue>
      </gpu:variable>
    </gpu:constants>

    <!-- Files of C code with initialisation, step and exit functions -->
    <gpu:functionFiles>
      <file>functions.c</file>
    </gpu:functionFiles>

    <!-- Functions that will run at the start of the simulation -->
    <gpu:initFunctions>
      <gpu:initFunction>
        <gpu:name>initialiseHost</gpu:name>
      </gpu:initFunction>
      <gpu:initFunction>
        <gpu:name>generateAgentsInit</gpu:name>
      </gpu:initFunction>
    </gpu:initFunctions>

    <!-- Functions that will run at the end of the simulation -->
    <gpu:exitFunctions>
      <gpu:exitFunction>
        <gpu:name>customOutputFunction</gpu:name>
      </gpu:exitFunction>
      <gpu:exitFunction>
        <gpu:name>exitFunction</gpu:name>
      </gpu:exitFunction>
    </gpu:exitFunctions>

    <!-- Functions that will run during each iteration -->
    <gpu:stepFunctions>
      <gpu:stepFunction>
        <gpu:name>generatePersonStep</gpu:name>
      </gpu:stepFunction>
    </gpu:stepFunctions>

  </gpu:environment>
  <xagents>

    <!-- Types of agents, such as people and households -->
    <gpu:xagent>
      <name>Person</name>

      <!-- The agent's memory, containing variables of various types -->
      <memory>
        <gpu:variable>
          <type>unsigned int</type>
          <name>id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>step</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>householdtime</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>churchtime</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>transporttime</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>age</name>
          <defaultValue>0</defaultValue>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>gender</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>householdsize</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>churchfreq</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>churchdur</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>transportuser</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>transportfreq</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>transportdur</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>transportday1</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>transportday2</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>household</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>church</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>transport</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>busy</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>startstep</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>location</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>locationid</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>hiv</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>art</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>activetb</name>
        </gpu:variable>
      </memory>

      <!-- Functions belonging to the agent -->
      <functions>
        <gpu:function>
          <name>update</name>
          <currentState>s2</currentState>
          <nextState>s2</nextState>
          <outputs>
            <gpu:output>
              <messageName>location</messageName>
              <gpu:type>single_message</gpu:type>
            </gpu:output>
          </outputs>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>true</gpu:RNG>
        </gpu:function>
        <gpu:function>
          <name>personhhinit</name>
          <currentState>default</currentState>
          <nextState>s2</nextState>
          <inputs>
            <gpu:input>
              <messageName>household_membership</messageName>
            </gpu:input>
          </inputs>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
        <gpu:function>
          <name>persontbinit</name>
          <currentState>default</currentState>
          <nextState>default</nextState>
          <inputs>
            <gpu:input>
              <messageName>tb_assignment</messageName>
            </gpu:input>
          </inputs>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
        <gpu:function>
          <name>persontrinit</name>
          <currentState>default</currentState>
          <nextState>default</nextState>
          <inputs>
            <gpu:input>
              <messageName>transport_membership</messageName>
            </gpu:input>
          </inputs>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <!-- States that the agent can be in during a given iteration -->
      <states>
        <gpu:state>
          <name>default</name>
        </gpu:state>
        <gpu:state>
          <name>s2</name>
        </gpu:state>
        <initialState>default</initialState>
      </states>

      <!-- Whether the agent is continuous or discrete -->
      <gpu:type>continuous</gpu:type>

      <!-- The buffer size that should be allocated to the agent - unpredictable results if too many agents generated -->
      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:xagent>

    <gpu:xagent>
      <name>TBAssignment</name>

      <memory>
        <gpu:variable>
          <type>unsigned int</type>
          <name>id</name>
        </gpu:variable>
      </memory>

      <functions>
        <gpu:function>
          <name>tbinit</name>
          <currentState>tbdefault</currentState>
          <nextState>tbdefault</nextState>
          <outputs>
            <gpu:output>
              <messageName>tb_assignment</messageName>
              <gpu:type>single_message</gpu:type>
            </gpu:output>
          </outputs>
          <gpu:reallocate>true</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <states>
        <gpu:state>
          <name>tbdefault</name>
        </gpu:state>
        <initialState>tbdefault</initialState>
      </states>

      <gpu:type>continuous</gpu:type>

      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:xagent>

    <gpu:xagent>
      <name>Household</name>

      <memory>
        <gpu:variable>
          <type>unsigned int</type>
          <name>id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>step</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>size</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>people</name>
          <arrayLength>32</arrayLength>
          <defaultValue>-1</defaultValue>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>churchgoing</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>churchfreq</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>adults</name>
        </gpu:variable>
      </memory>

      <functions>
        <gpu:function>
          <name>hhupdate</name>
          <currentState>hhdefault</currentState>
          <nextState>hhdefault</nextState>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <states>
        <gpu:state>
          <name>hhdefault</name>
        </gpu:state>
        <initialState>hhdefault</initialState>
      </states>

      <gpu:type>continuous</gpu:type>

      <gpu:bufferSize>8192</gpu:bufferSize>
    </gpu:xagent>

    <gpu:xagent>
      <name>HouseholdMembership</name>

      <memory>
        <gpu:variable>
          <type>unsigned int</type>
          <name>household_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>person_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>household_size</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>churchgoing</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>churchfreq</name>
        </gpu:variable>
      </memory>

      <functions>
        <gpu:function>
          <name>hhinit</name>
          <currentState>hhmembershipdefault</currentState>
          <nextState>hhmembershipdefault</nextState>
          <inputs>
            <gpu:input>
              <messageName>church_membership</messageName>
            </gpu:input>
          </inputs>
          <outputs>
            <gpu:output>
              <messageName>household_membership</messageName>
              <gpu:type>single_message</gpu:type>
            </gpu:output>
          </outputs>
          <gpu:reallocate>true</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <states>
        <gpu:state>
          <name>hhmembershipdefault</name>
        </gpu:state>
        <initialState>hhmembershipdefault</initialState>
      </states>

      <gpu:type>continuous</gpu:type>

      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:xagent>

    <gpu:xagent>
      <name>Church</name>

      <memory>
        <gpu:variable>
          <type>unsigned int</type>
          <name>id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>step</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>size</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>duration</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>households</name>
          <arrayLength>128</arrayLength>
          <defaultValue>-1</defaultValue>
        </gpu:variable>
      </memory>

      <functions>
        <gpu:function>
          <name>chuupdate</name>
          <currentState>chudefault</currentState>
          <nextState>chudefault</nextState>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <states>
        <gpu:state>
          <name>chudefault</name>
        </gpu:state>
        <initialState>chudefault</initialState>
      </states>

      <gpu:type>continuous</gpu:type>

      <gpu:bufferSize>256</gpu:bufferSize>
    </gpu:xagent>

    <gpu:xagent>
      <name>ChurchMembership</name>

      <memory>
        <gpu:variable>
          <type>unsigned int</type>
          <name>church_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>household_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>churchdur</name>
        </gpu:variable>
      </memory>

      <functions>
        <gpu:function>
          <name>chuinit</name>
          <currentState>chumembershipdefault</currentState>
          <nextState>chumembershipdefault</nextState>
          <outputs>
            <gpu:output>
              <messageName>church_membership</messageName>
              <gpu:type>single_message</gpu:type>
            </gpu:output>
          </outputs>
          <gpu:reallocate>true</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <states>
        <gpu:state>
          <name>chumembershipdefault</name>
        </gpu:state>
        <initialState>chumembershipdefault</initialState>
      </states>

      <gpu:type>continuous</gpu:type>

      <gpu:bufferSize>8192</gpu:bufferSize>
    </gpu:xagent>

    <gpu:xagent>
      <name>Transport</name>

      <memory>
        <gpu:variable>
          <type>unsigned int</type>
          <name>id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>step</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>duration</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>day</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>people</name>
          <arrayLength>16</arrayLength>
          <defaultValue>-1</defaultValue>
        </gpu:variable>
      </memory>

      <functions>
        <gpu:function>
          <name>trupdate</name>
          <currentState>trdefault</currentState>
          <nextState>trdefault</nextState>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <states>
        <gpu:state>
          <name>trdefault</name>
        </gpu:state>
        <initialState>trdefault</initialState>
      </states>

      <gpu:type>continuous</gpu:type>

      <gpu:bufferSize>2048</gpu:bufferSize>
    </gpu:xagent>

    <gpu:xagent>
      <name>TransportMembership</name>

      <memory>
        <gpu:variable>
          <type>int</type>
          <name>person_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>transport_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>duration</name>
        </gpu:variable>
      </memory>

      <functions>
        <gpu:function>
          <name>trinit</name>
          <currentState>trmembershipdefault</currentState>
          <nextState>trmembershipdefault</nextState>
          <outputs>
            <gpu:output>
              <messageName>transport_membership</messageName>
              <gpu:type>single_message</gpu:type>
            </gpu:output>
          </outputs>
          <gpu:reallocate>true</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
      </functions>

      <states>
        <gpu:state>
          <name>trmembershipdefault</name>
        </gpu:state>
        <initialState>trmembershipdefault</initialState>
      </states>

      <gpu:type>continuous</gpu:type>

      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:xagent>

  </xagents>

  <!-- Messages sent by agents which can be read by other agents -->
  <messages>

    <gpu:message>
      <name>tb_assignment</name>
      <description>A message declaring that a person has active TB</description>
      <variables>
        <gpu:variable>
          <type>unsigned int</type>
          <name>id</name>
        </gpu:variable>
      </variables>
      <gpu:partitioningNone/>
      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:message>

    <gpu:message>
      <name>household_membership</name>
      <description>A message declaring that a person is a member of a household</description>
      <variables>
        <gpu:variable>
          <type>unsigned int</type>
          <name>household_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>person_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>household_size</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>church_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>churchfreq</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>churchdur</name>
        </gpu:variable>
      </variables>
      <gpu:partitioningNone/>
      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:message>

    <gpu:message>
      <name>church_membership</name>
      <description>A message declaring that a household is a member of a church</description>
      <variables>
        <gpu:variable>
          <type>unsigned int</type>
          <name>church_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>household_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>churchdur</name>
        </gpu:variable>
      </variables>
      <gpu:partitioningNone/>
      <gpu:bufferSize>8192</gpu:bufferSize>
    </gpu:message>

    <gpu:message>
      <name>transport_membership</name>
      <description>A message declaring that a person uses a transport</description>
      <variables>
        <gpu:variable>
          <type>unsigned int</type>
          <name>person_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>transport_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>duration</name>
        </gpu:variable>
      </variables>
      <gpu:partitioningNone/>
      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:message>

    <gpu:message>
      <name>location</name>
      <description>A message declaring that a person is in a given location at a given time</description>
      <variables>
        <gpu:variable>
          <type>unsigned int</type>
          <name>person_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>location_type</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>location_id</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>day</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>hour</name>
        </gpu:variable>
        <gpu:variable>
          <type>unsigned int</type>
          <name>minute</name>
        </gpu:variable>
      </variables>
      <gpu:partitioningNone/>
      <gpu:bufferSize>32768</gpu:bufferSize>
    </gpu:message>

  </messages>

  <layers>

    <layer>
      <gpu:layerFunction>
        <name>tbinit</name>
      </gpu:layerFunction>
    </layer>

    <layer>
      <gpu:layerFunction>
        <name>trinit</name>
      </gpu:layerFunction>
    </layer>

    <layer>
      <gpu:layerFunction>
        <name>chuinit</name>
      </gpu:layerFunction>
    </layer>

    <layer>
      <gpu:layerFunction>
        <name>hhinit</name>
      </gpu:layerFunction>
    </layer>

    <layer>
      <gpu:layerFunction>
        <name>persontrinit</name>
      </gpu:layerFunction>
    </layer>

    <layer>
      <gpu:layerFunction>
        <name>persontbinit</name>
      </gpu:layerFunction>
    </layer>

    <layer>
      <gpu:layerFunction>
        <name>personhhinit</name>
      </gpu:layerFunction>
    </layer>

    <layer>
      <gpu:layerFunction>
        <name>update</name>
      </gpu:layerFunction>
    </layer>
  </layers>

</gpu:xmodel>

